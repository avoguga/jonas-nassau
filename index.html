<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Corrida VR - Prot√≥tipo</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }
    #play-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(0,0,0,0.95), rgba(20,20,40,0.95));
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      cursor: pointer;
    }
    #play-overlay h1 {
      color: #00ff88;
      font-size: 48px;
      margin-bottom: 20px;
      font-family: 'Arial Black', sans-serif;
      text-shadow: 0 0 20px rgba(0,255,136,0.5);
    }
    #play-overlay button {
      padding: 30px 70px;
      font-size: 36px;
      background: linear-gradient(135deg, #00ff88, #00cc66);
      color: #000;
      border: none;
      border-radius: 60px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 15px 40px rgba(0, 255, 136, 0.6);
      transition: all 0.3s;
      font-family: 'Arial Black', sans-serif;
    }
    #play-overlay button:hover {
      transform: scale(1.1) translateY(-5px);
      box-shadow: 0 20px 50px rgba(0, 255, 136, 0.8);
    }
  </style>
</head>
<body>
  <!-- Overlay de Play -->
  <div id="play-overlay">
    <h1>üèÉ CORRIDA VR</h1>
    <button id="start-button">‚ñ∂ INICIAR EXPERI√äNCIA</button>
  </div>

  <a-scene>
    <!-- Assets -->
    <a-assets>
      <!-- V√≠deo 360 Equirectangular - jfk.webm -->
      <video id="video360"
             playsinline
             webkit-playsinline
             loop="true"
             muted
             preload="auto"
             crossorigin="anonymous">
        <source src="jfk.webm" type="video/webm">
      </video>
    </a-assets>

    <!-- V√≠deo 360 como videosphere -->
    <a-videosphere src="#video360" rotation="0 180 0"></a-videosphere>

    <!-- C√¢mera com controles -->
    <a-entity id="camera-rig" position="0 0 0">
      <a-camera id="main-camera" look-controls wasd-controls="acceleration: 20">
        <a-cursor color="#00FF88"></a-cursor>

        <!-- UI fixa na c√¢mera (HUD) - Canto Inferior Esquerdo -->
        <a-entity id="hud" position="-1.4 -0.75 -2.2">

          <!-- Fundo principal com gradiente simulado -->
          <a-plane color="#0a0a1a" opacity="0.92" width="1.1" height="0.95"
                   radius="0.08" position="0.55 0.475 -0.01"></a-plane>

          <!-- Borda decorativa -->
          <a-plane color="#00ff88" opacity="0.3" width="1.14" height="0.99"
                   radius="0.09" position="0.55 0.475 -0.02"></a-plane>

          <!-- Header -->
          <a-entity position="0.1 0.85 0.01">
            <a-text value="üèÉ M√âTRICAS" color="#00ff88" width="1.8"
                    align="left" shader="flat" font="roboto"></a-text>
          </a-entity>

          <!-- Linha divis√≥ria -->
          <a-plane color="#00ff88" opacity="0.5" width="0.95" height="0.01"
                   position="0.525 0.72 0.01"></a-plane>

          <!-- Card de Velocidade -->
          <a-entity position="0.1 0.55 0.01">
            <!-- √çcone de fundo -->
            <a-plane color="#00ff88" opacity="0.15" width="0.9" height="0.18"
                     radius="0.03" position="0.4 0 -0.005"></a-plane>
            <a-text value="‚ö° VELOCIDADE" color="#00ff88" width="1.3"
                    align="left" shader="flat"></a-text>
            <a-text id="speed-value" value="0.0" color="#ffffff"
                    width="2.5" align="left" position="0 -0.12 0"
                    shader="flat" font="roboto"></a-text>
            <a-text value="km/h" color="#aaaaaa" width="0.9"
                    align="left" position="0.45 -0.12 0" shader="flat"></a-text>
          </a-entity>

          <!-- Card de Passos -->
          <a-entity position="0.1 0.25 0.01">
            <!-- √çcone de fundo -->
            <a-plane color="#ff6b6b" opacity="0.15" width="0.9" height="0.18"
                     radius="0.03" position="0.4 0 -0.005"></a-plane>
            <a-text value="üë£ PASSOS" color="#ff6b6b" width="1.3"
                    align="left" shader="flat"></a-text>
            <a-text id="steps-value" value="0" color="#ffffff"
                    width="2.5" align="left" position="0 -0.12 0"
                    shader="flat" font="roboto"></a-text>
            <a-text value="steps" color="#aaaaaa" width="0.9"
                    align="left" position="0.35 -0.12 0" shader="flat"></a-text>
          </a-entity>

          <!-- Card de Dist√¢ncia -->
          <a-entity position="0.1 -0.05 0.01">
            <!-- √çcone de fundo -->
            <a-plane color="#4ecdc4" opacity="0.15" width="0.9" height="0.18"
                     radius="0.03" position="0.4 0 -0.005"></a-plane>
            <a-text value="üìç DIST√ÇNCIA" color="#4ecdc4" width="1.3"
                    align="left" shader="flat"></a-text>
            <a-text id="distance-value" value="0.0" color="#ffffff"
                    width="2.5" align="left" position="0 -0.12 0"
                    shader="flat" font="roboto"></a-text>
            <a-text value="metros" color="#aaaaaa" width="0.9"
                    align="left" position="0.45 -0.12 0" shader="flat"></a-text>
          </a-entity>

          <!-- Card de Tempo -->
          <a-entity position="0.1 -0.35 0.01">
            <!-- √çcone de fundo -->
            <a-plane color="#ffd93d" opacity="0.15" width="0.9" height="0.18"
                     radius="0.03" position="0.4 0 -0.005"></a-plane>
            <a-text value="‚è±Ô∏è TEMPO" color="#ffd93d" width="1.3"
                    align="left" shader="flat"></a-text>
            <a-text id="time-value" value="00:00" color="#ffffff"
                    width="2.2" align="left" position="0 -0.12 0"
                    shader="flat" font="roboto"></a-text>
            <a-text value="min" color="#aaaaaa" width="0.9"
                    align="left" position="0.4 -0.12 0" shader="flat"></a-text>
          </a-entity>

        </a-entity>
      </a-camera>
    </a-entity>

    <!-- Luz ambiente -->
    <a-light type="ambient" color="#BBB"></a-light>
  </a-scene>

  <script>
    // Componente de simula√ß√£o de corrida
    AFRAME.registerComponent('running-simulator', {
      init: function() {
        this.isRunning = false;
        this.startTime = 0;
        this.elapsedTime = 0;

        // M√©tricas da corrida
        this.totalDistance = 0;
        this.steps = 0;
        this.currentSpeed = 0;
        this.targetSpeed = 0;

        // Par√¢metros da corrida
        this.baseSpeed = 8; // km/h base
        this.maxSpeed = 15; // km/h m√°ximo
        this.minSpeed = 5; // km/h m√≠nimo

        // Refer√™ncias aos elementos de texto
        this.speedText = document.querySelector('#speed-value');
        this.stepsText = document.querySelector('#steps-value');
        this.distanceText = document.querySelector('#distance-value');
        this.timeText = document.querySelector('#time-value');

        // Para controle de passos
        this.stepTimer = 0;
        this.stepInterval = 0.5; // segundos entre passos na velocidade base
      },

      start: function() {
        this.isRunning = true;
        this.startTime = Date.now();
        console.log('Simula√ß√£o de corrida iniciada!');
      },

      stop: function() {
        this.isRunning = false;
      },

      tick: function(time, deltaTime) {
        if (!this.isRunning) return;

        const deltaSec = deltaTime / 1000;
        this.elapsedTime = (Date.now() - this.startTime) / 1000;

        // Varia a velocidade alvo de forma suave e real√≠stica
        // Usa seno para criar varia√ß√µes naturais
        const speedVariation = Math.sin(this.elapsedTime * 0.3) * 2 +
                              Math.sin(this.elapsedTime * 0.7) * 1.5;
        this.targetSpeed = this.baseSpeed + speedVariation;
        this.targetSpeed = Math.max(this.minSpeed, Math.min(this.maxSpeed, this.targetSpeed));

        // Interpola suavemente para a velocidade alvo
        this.currentSpeed += (this.targetSpeed - this.currentSpeed) * 0.05;

        // Calcula dist√¢ncia percorrida neste frame
        // Velocidade em km/h -> m/s -> metros percorridos
        const distanceThisFrame = (this.currentSpeed / 3.6) * deltaSec;
        this.totalDistance += distanceThisFrame;

        // Calcula passos baseado na velocidade
        // Quanto mais r√°pido, menos tempo entre passos
        const currentStepInterval = this.stepInterval * (this.baseSpeed / this.currentSpeed);
        this.stepTimer += deltaSec;

        if (this.stepTimer >= currentStepInterval) {
          this.steps++;
          this.stepTimer = 0;
        }

        // Atualiza UI
        this.updateUI();
      },

      updateUI: function() {
        if (this.speedText) {
          this.speedText.setAttribute('value', this.currentSpeed.toFixed(1));
        }
        if (this.stepsText) {
          this.stepsText.setAttribute('value', this.steps.toString());
        }
        if (this.distanceText) {
          this.distanceText.setAttribute('value', this.totalDistance.toFixed(0));
        }
        if (this.timeText) {
          const minutes = Math.floor(this.elapsedTime / 60);
          const seconds = Math.floor(this.elapsedTime % 60);
          const timeStr = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
          this.timeText.setAttribute('value', timeStr);
        }
      }
    });

    // Sistema de controle de v√≠deo
    AFRAME.registerComponent('video-controls', {
      init: function() {
        const video = document.querySelector('#video360');
        const startButton = document.querySelector('#start-button');
        const playOverlay = document.querySelector('#play-overlay');
        const cameraRig = document.querySelector('#camera-rig');

        // Fun√ß√£o para iniciar v√≠deo e simula√ß√£o
        const startExperience = () => {
          console.log('Iniciando experi√™ncia...');

          // Inicia o v√≠deo
          video.play().then(() => {
            console.log('V√≠deo iniciado com sucesso!');
            playOverlay.style.display = 'none';

            // Inicia a simula√ß√£o de corrida
            const simulator = cameraRig.components['running-simulator'];
            if (simulator) {
              simulator.start();
            }
          }).catch((error) => {
            console.error('Erro ao iniciar v√≠deo:', error);
            // Tenta m√©todo alternativo do A-Frame
            try {
              const videosphere = document.querySelector('a-videosphere');
              if (videosphere && videosphere.components && videosphere.components.material) {
                const videoElement = videosphere.components.material.material.map.image;
                videoElement.play();
                playOverlay.style.display = 'none';

                // Inicia a simula√ß√£o de corrida
                const simulator = cameraRig.components['running-simulator'];
                if (simulator) {
                  simulator.start();
                }
              }
            } catch(e) {
              console.error('M√©todo alternativo falhou:', e);
            }
          });
        };

        // Evento do bot√£o
        if (startButton) {
          startButton.addEventListener('click', startExperience);
        }

        // Previne autoplay
        video.pause();
      }
    });

    // Quando a cena carregar
    document.addEventListener('DOMContentLoaded', function() {
      const scene = document.querySelector('a-scene');

      scene.addEventListener('loaded', function() {
        console.log('Cena A-Frame carregada');

        // Adiciona componentes
        const cameraRig = document.querySelector('#camera-rig');
        if (cameraRig) {
          cameraRig.setAttribute('running-simulator', '');
        }

        const sceneEl = document.querySelector('a-scene');
        if (sceneEl) {
          sceneEl.setAttribute('video-controls', '');
        }
      });
    });
  </script>
</body>
</html>
